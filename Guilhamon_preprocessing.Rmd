---
title: "Guilhamon_preprocessing"
author: "Ronald Wu"
date: '2024-03-05'
output: html_document
---
# Introduction
The purpose of this notebook is to a document the process for downloading and pre-processing the original files from Paul's scATAC-seq [study](https://elifesciences.org/articles/64090). The supplementary processed files deposited on GEO as [GSE139136](https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE139136) was insufficient for our analysis using Signac. Specifically, we need the fragments.tsv.gz file, which can be generated by running cellranger on the original fastq files. These raw files are available on SRA.

# Load Modules on Computing Cluster
Make sure you are on the H4H cluster login node, since we need internet connection to download the datasets.

```{bash load modules}
module load sratoolkit/3.0.7
```

# Download FASTQ-files from SRA-accessions

## Method 1: Using commands from SRA toolkit (prefetch)

The login node for the computing cluster has access to the internet. We can load the SRA toolkit, which is installed on the cluster, and run commands to download the dataset in `.sra` format.

The following commands are based on the [documentation](https://github.com/ncbi/sra-tools/wiki/08.-prefetch-and-fasterq-dump).

Note: In my experience, this downloading process is very slow. Direct download may be faster (see method 2). However, if fastq files may need to be built from the SRA file and may differ from the fastq offered from direct download.

```{bash download files from SRA}
# on the login node
module load sratoolkit/3.0.7
cd ~
mkdir SRA
cd ~/SRA

prefetch SRR10315835
prefetch SRR10315836
prefetch SRR10315837
prefetch SRR10315838
```
Note: The size of the .sra file (~4 gb each) may exceed allocations for the login node. Additional files are also downloaded in the folder containing the SRA file.
> [rwu@h4huhnlogin1 SRA]$ ls SRR10315835/
CM000663.1  CM000672.1  CM000681.1  GL000194.1  GL000203.1  GL000212.1  GL000221.1  GL000230.1  GL000239.1  GL000248.1
CM000664.1  CM000673.1  CM000682.1  GL000195.1  GL000204.1  GL000213.1  GL000222.1  GL000231.1  GL000240.1  GL000249.1
CM000665.1  CM000674.1  CM000683.1  GL000196.1  GL000205.1  GL000214.1  GL000223.1  GL000232.1  GL000241.1  NC_007605.1
CM000666.1  CM000675.1  CM000684.1  GL000197.1  GL000206.1  GL000215.1  GL000224.1  GL000233.1  GL000242.1  NC_012920.1
CM000667.1  CM000676.1  CM000685.1  GL000198.1  GL000207.1  GL000216.1  GL000225.1  GL000234.1  GL000243.1  SRR10315835.sra
CM000668.1  CM000677.1  CM000686.1  GL000199.1  GL000208.1  GL000217.1  GL000226.1  GL000235.1  GL000244.1  SRR10315835.sra.vdbcache
CM000669.1  CM000678.1  GL000191.1  GL000200.1  GL000209.1  GL000218.1  GL000227.1  GL000236.1  GL000245.1
CM000670.1  CM000679.1  GL000192.1  GL000201.1  GL000210.1  GL000219.1  GL000228.1  GL000237.1  GL000246.1
CM000671.1  CM000680.1  GL000193.1  GL000202.1  GL000211.1  GL000220.1  GL000229.1  GL000238.1  GL000247.1

```{bash extract with fastq-dump}
module load sratoolkit/3.0.7

cd /cluster/home/rwu/SRA
fastq-dump --split-files --origfmt --defline-seq '@rd.$si:$sg:$sn' SRR10315835/SRR10315835.sra
```
Above command from [Not A Rocket Scientist](https://notarocketscientist.xyz/posts/2022-07-26-getting-index-reads-from-sra/). Needs to be done on build partition since you will get a `fail to call services` error if no internet. However, we ran out of space here. 

```{bash extract with fastq-dump without internet}
module load sratoolkit/3.0.7
cd /cluster/projects/wouterslab/scATAC/Guilhamon/SRA

fastq-dump --split-files --origfmt --defline-seq '@rd.$si:$sg:$sn' SRR10315835 -v --outdir fastq/

cd fastq

```
> [rwu@node124 fastq]$ ls -ltrh
total 60G
-rw-r--r-- 1 rwu wouterslab 25G Mar 11 18:15 SRR10315835_1.fastq
-rw-r--r-- 1 rwu wouterslab 25G Mar 11 18:15 SRR10315835_2.fastq

The ~4.0G .sra file turned into 2 fastq at 50G total.

```{bash rename and run cellranger-atac}
cd /cluster/projects/wouterslab/scATAC/Guilhamon/SRA/fastq
mv SRR10315835_1.fastq GBM_4218_S1_L001_R1_001.fastq
mv SRR10315835_2.fastq GBM_4218_S1_L001_R2_001.fastq

cd /cluster/projects/wouterslab/scATAC/Guilhamon/SRA/
sbatch ~/scripts/cellranger-atac-count.sh \
GBM_4218 \
fastq/
```

```{bash extract with fasterq-dump}
module load sratoolkit/3.0.7
cd /cluster/projects/wouterslab/scATAC/Guilhamon/SRA

fasterq-dump --split-files --include-technical SRR10315835 --outdir fastq
fasterq-dump --split-files --include-technical SRR10315835 --outdir fastq --verbose
```
Instructions for fasterq-dump can be found [here](https://github.com/ncbi/sra-tools/wiki/HowTo:-fasterq-dump).
fasterq-dump is faster than fastq-dump, but the syntax is a bit different. Can also use without internet if specified using `vdb-config -i`. 

Problem: No fastq files were made in the fastq/ outdir. Only `fasterq-tmp` folder was generated with `.dat` files. Usually this temp folder is removed and fastq is generated. Didn't see any errors when we ran the command with `--verbose`.

## Bare accession needs internet
```{bash fasterq-dump SRR000001}
cd /cluster/home/rwu/SRA

# run vdb-config interactively and enable remote access (internet)
vdb-config -i

# default (split-3 is used by default, explicit flag is --split-3)
fasterq-dump SRR000001
```
> spots read      : 470,985
reads read      : 1,883,940
reads written   : 707,026
reads 0-length  : 468,635
technical reads : 708,279
> [rwu@h4huhnlogin1 SRA]$ ls -ltrh
total 299M
-rw-r--r-- 1 rwu wouterslab  584 Mar  6 11:53 paul.txt
drwxr-xr-x 2 rwu wouterslab 2.4K Mar  8 21:04 SRR10315835
-rw-r--r-- 1 rwu wouterslab  68M Mar 11 16:17 SRR000001_1.fastq
-rw-r--r-- 1 rwu wouterslab  76M Mar 11 16:17 SRR000001_2.fastq
-rw-r--r-- 1 rwu wouterslab 141M Mar 11 16:17 SRR000001.fastq

The temp folder was removed and we ended up with 3 fastq for SRR000001 in the current working directory
Note: On compute cluster, the same command returned an error
> fasterq-dump quit with error code 3


## Method 2: Using custom script from sra-explorer

There is a convenient [website](https://sra-explorer.info/) that let's you search for all the datasets you want to download and adds them to a shopping cart. Then, this cart will show and format various methods for download, including bash scripts which we can use on the cluster.

All 4 of the scATAC-seq samples were entered:
1. SRR10315835
2. SRR10315836
3. SRR10315837
4. SRR10315838

The following bash script was generated to download the fastq files directly. Note: The header was changed for use on the slurm scheduler. The build partition is selected because it has internet access.

```{bash download files via script}
#!/bin/sh
#SBATCH -t 2:00:00
#SBATCH -J sradownload
#SBATCH -p build
#SBATCH -c 1
#SBATCH -N 1
#SBATCH -o %x-%j.out
curl -L ftp://ftp.sra.ebi.ac.uk/vol1/fastq/SRR103/035/SRR10315835/SRR10315835.fastq.gz -o SRR10315835_GSM4131776_GBM_4218_Homo_sapiens_ATAC-seq.fastq.gz
curl -L ftp://ftp.sra.ebi.ac.uk/vol1/fastq/SRR103/035/SRR10315835/SRR10315835_1.fastq.gz -o SRR10315835_GSM4131776_GBM_4218_Homo_sapiens_ATAC-seq_1.fastq.gz
curl -L ftp://ftp.sra.ebi.ac.uk/vol1/fastq/SRR103/035/SRR10315835/SRR10315835_2.fastq.gz -o SRR10315835_GSM4131776_GBM_4218_Homo_sapiens_ATAC-seq_2.fastq.gz
curl -L ftp://ftp.sra.ebi.ac.uk/vol1/fastq/SRR103/038/SRR10315838/SRR10315838.fastq.gz -o SRR10315838_GSM4131779_GBM_4349_Homo_sapiens_ATAC-seq.fastq.gz
curl -L ftp://ftp.sra.ebi.ac.uk/vol1/fastq/SRR103/038/SRR10315838/SRR10315838_1.fastq.gz -o SRR10315838_GSM4131779_GBM_4349_Homo_sapiens_ATAC-seq_1.fastq.gz
curl -L ftp://ftp.sra.ebi.ac.uk/vol1/fastq/SRR103/038/SRR10315838/SRR10315838_2.fastq.gz -o SRR10315838_GSM4131779_GBM_4349_Homo_sapiens_ATAC-seq_2.fastq.gz
curl -L ftp://ftp.sra.ebi.ac.uk/vol1/fastq/SRR103/036/SRR10315836/SRR10315836.fastq.gz -o SRR10315836_GSM4131777_GBM_4250_Homo_sapiens_ATAC-seq.fastq.gz
curl -L ftp://ftp.sra.ebi.ac.uk/vol1/fastq/SRR103/036/SRR10315836/SRR10315836_1.fastq.gz -o SRR10315836_GSM4131777_GBM_4250_Homo_sapiens_ATAC-seq_1.fastq.gz
curl -L ftp://ftp.sra.ebi.ac.uk/vol1/fastq/SRR103/036/SRR10315836/SRR10315836_2.fastq.gz -o SRR10315836_GSM4131777_GBM_4250_Homo_sapiens_ATAC-seq_2.fastq.gz
curl -L ftp://ftp.sra.ebi.ac.uk/vol1/fastq/SRR103/037/SRR10315837/SRR10315837.fastq.gz -o SRR10315837_GSM4131778_GBM_4275_Homo_sapiens_ATAC-seq.fastq.gz
curl -L ftp://ftp.sra.ebi.ac.uk/vol1/fastq/SRR103/037/SRR10315837/SRR10315837_1.fastq.gz -o SRR10315837_GSM4131778_GBM_4275_Homo_sapiens_ATAC-seq_1.fastq.gz
curl -L ftp://ftp.sra.ebi.ac.uk/vol1/fastq/SRR103/037/SRR10315837/SRR10315837_2.fastq.gz -o SRR10315837_GSM4131778_GBM_4275_Homo_sapiens_ATAC-seq_2.fastq.gz
```

The above script was saved as `paul.txt`. 
Each sample has three files, two of which are the paired end reads denoted with _1 and _2 suffix. 
The third file is small and can be ignored according to [this biostars post](https://www.biostars.org/p/156909/). They are apparently orphaned reads after trimming.

Also, the build partition has a 2 hr time limit, which might not be enough to download all the files.
```{bash run script}
cd ~/SRA
squeue paul.txt
```

```{bash copy files over}
cd /cluster/projects/wouterslab
mkdir -p scATAC/Guilhamon

cp ~/SRA/*fastq.gz /cluster/projects/wouterslab/scATAC/Guilhamon
```

## Method 3:
Download the original BAM files and then use `bamtofastq` to convert to fastq. 

# Rename fastq for use with Cell Ranger

Cellranger requires the fastq files to follow the naming convention employed by `bcl2fastq`:

[Sample Name]_S1_L00[Lane Number]_[Read Type]_001.fastq.gz

Where Read Type is one of:

I1: Sample index read (optional)
I2: Sample index read (optional)
R1: Read 1 (required)
R2: Read 2 (required)

```{bash renaming fastqs}
cd /cluster/projects/wouterslab/scATAC/Guilhamon
# make folders named after each patient sample
mkdir fastq/{GBM_4218,GBM_4250,GBM_4275,GBM_4349}
# move fastqs
mv *GBM_4218*_{1,2}* fastq/GBM_4218/
mv *GBM_4250*_{1,2}* fastq/GBM_4250/
mv *GBM_4275*_{1,2}* fastq/GBM_4275/
mv *GBM_4349*_{1,2}* fastq/GBM_4349/

# rename files
mv fastq/GBM_4218/SRR10315835_GSM4131776_GBM_4218_Homo_sapiens_ATAC-seq_1.fastq.gz fastq/GBM_4218/GBM_4218_S1_L001_R1_001.fastq.gz
mv fastq/GBM_4218/SRR10315835_GSM4131776_GBM_4218_Homo_sapiens_ATAC-seq_2.fastq.gz fastq/GBM_4218/GBM_4218_S1_L001_R2_001.fastq.gz

mv fastq/GBM_4250/SRR10315836_GSM4131777_GBM_4250_Homo_sapiens_ATAC-seq_1.fastq.gz fastq/GBM_4250/GBM_4250_S1_L001_R1_001.fastq.gz
mv fastq/GBM_4250/SRR10315836_GSM4131777_GBM_4250_Homo_sapiens_ATAC-seq_2.fastq.gz fastq/GBM_4250/GBM_4250_S1_L001_R2_001.fastq.gz

mv fastq/GBM_4275/SRR10315837_GSM4131778_GBM_4275_Homo_sapiens_ATAC-seq_1.fastq.gz fastq/GBM_4275/GBM_4275_S1_L001_R1_001.fastq.gz
mv fastq/GBM_4275/SRR10315837_GSM4131778_GBM_4275_Homo_sapiens_ATAC-seq_2.fastq.gz fastq/GBM_4275/GBM_4275_S1_L001_R2_001.fastq.gz

mv fastq/GBM_4349/SRR10315838_GSM4131779_GBM_4349_Homo_sapiens_ATAC-seq_1.fastq.gz fastq/GBM_4349/GBM_4349_S1_L001_R1_001.fastq.gz
mv fastq/GBM_4349/SRR10315838_GSM4131779_GBM_4349_Homo_sapiens_ATAC-seq_2.fastq.gz fastq/GBM_4349/GBM_4349_S1_L001_R2_001.fastq.gz

```

However, the files we download from SRA are not named in that format and require some modification
# Run cellranger-atac count pipeline
Since we are working with fastq files directly, we can skip the part of the pipeline where the raw bcl files are converted to fastq files using `cellranger-atac mkfastq`. We can directly use the `cellranger-atac count` function.

The bottom is example code for running `cellranger-atac count` locally from the 10x genomics website:

```{bash run cellranger-atac count locally}
cd /home/jdoe/runs
cellranger-atac count --id=sample345 \
                        --reference=/opt/refdata-cellranger-arc-GRCh38-2020-A-2.0.0 \
                        --fastqs=/home/jdoe/runs/HAWT7ADXX/outs/fastq_path \
                        --sample=mysample \
                        --localcores=8 \
                        --localmem=64
```

Some questions based on the example commands above:
1. Where is the transcriptome reference on the H4h cluster?
There are several options:
1. For cell ranger atac version 2.0.0
/cluster/tools/data/commondata/cellranger/refdata-cellranger-arc-GRCh38-2020-A-2.0.0
2. For use with cell ranger atac version 1.2.0
/cluster/tools/data/commondata/cellranger/refdata-cellranger-atac-GRCh38-1.2.0
3. for gene expression (GEX) analysis
/cluster/tools/data/commondata/cellranger/refdata-gex-GRCh38-2020-A

Let's use `cellranger/refdata-cellranger-arc-GRCh38-2020-A-2.0.0`, since it was the one used in the 10x genomics atac website. Also, `cellranger-atac/2.1.0` is the module on the cluster.

Next, we need to modify this code and add it to a script to submit as a batch job on slurm. Some examples of this can be found on [biowolf](https://hpc.nih.gov/apps/cellranger-atac.html). We saved the script `cellranger-atac-count.sh` at the ~/scripts folder.

```{bash cellranger-atac-count.sh batch job }
cd /cluster/projects/wouterslab/scATAC/Guilhamon

sbatch ~/scripts/cellranger-atac-count.sh \
GBM_4218 \
fastq/GBM_4218

sbatch ~/scripts/cellranger-atac-count.sh \
GBM_4250 \
fastq/GBM_4250

sbatch ~/scripts/cellranger-atac-count.sh \
GBM_4275 \
fastq/GBM_4275

sbatch ~/scripts/cellranger-atac-count.sh \
GBM_4349 \
fastq/GBM_4349
```

Troubleshooting:
1. Remember we had three fastq files downloaded. perhaps the third one is the i5 index. let's rename it
apparently R3 is used to denote read 2
```
mv GBM_4218_S1_L001_R2_001.fastq.gz GBM_4218_S1_L001_R3_001.fastq.gz
mv SRR10315835_GSM4131776_GBM_4218_Homo_sapiens_ATAC-seq.fastq.gz fastq/GBM_4218
mv SRR10315835_GSM4131776_GBM_4218_Homo_sapiens_ATAC-seq.fastq.gz GBM_4218_S1_L001_R2_001.fastq.gz
```


